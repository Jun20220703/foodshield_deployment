<div class="layout">
  <!-- Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Main content -->
  <div class="content">
    <!-- Header -->
    <header class="inventory-header">
      <div class="inventory-title">
        <label>{{ viewTitle }}</label>
        <div class="select-wrapper">
          <!-- ðŸ”¹ ä¸‹æ‹‰åˆ—è¡¨ï¼šåŠ¨æ€ Storage -->
          <select [(ngModel)]="selectedLocation" (ngModelChange)="refreshView()">
            <option value="All">All</option>
            <option *ngFor="let loc of availableLocations" [value]="loc">{{ loc }}</option>
          </select>
          <span class="custom-arrow">â–¼</span>
        </div>
      </div>

      <div class="header-icons">
        <i class="fa-solid fa-magnifying-glass header-icon" (click)="toggleSearchBar()"></i>
        <i class="fa-solid fa-sliders header-icon" (click)="toggleFilterPanel()"></i>
      </div>
    </header>

    <!-- Search bar -->
    <div *ngIf="showSearch" class="search-bar">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (ngModelChange)="refreshView()"
        placeholder="Search food items..." />
    </div>

    <!-- Filter Drawer -->
    <div class="filter-drawer" [class.open]="showFilter">
      <div class="filter-header">
        <h2>Filters</h2>
        <button class="close-btn" (click)="toggleFilterPanel()">Ã—</button>
      </div>

      <!-- Source -->
      <div class="filter-section">
        <h3>Source</h3>
        <label>
          <input
            type="radio"
            name="source"
            value="inventory"
            [(ngModel)]="selectedSource"
            (ngModelChange)="toggleSource($event)" />
          Inventory only
        </label>
        <label>
          <input
            type="radio"
            name="source"
            value="donation"
            [(ngModel)]="selectedSource"
            (ngModelChange)="toggleSource($event)" />
          Donation List
        </label>
      </div>

      <!-- Category -->
      <div class="filter-section">
        <h3>Category</h3>

        <!-- All -->
        <label>
          <input
            type="checkbox"
            name="cat_all"
            [(ngModel)]="filter.categories.all"
            (ngModelChange)="onCategoryAllToggle($event)" />
          All
        </label>

        <!-- åŠ¨æ€åˆ†ç±» -->
        <label *ngFor="let cat of availableCategories">
          <input
            type="checkbox"
            name="cat_{{cat.key}}"
            [checked]="filter.categories[cat.key] === true"
            (change)="onCategoryChange(cat.key, $event.target.checked)" />
          {{ cat.name }}
        </label>
      </div>

      <!-- âœ… Expired in åªåœ¨ Inventory æ¨¡å¼ä¸‹æ˜¾ç¤º -->
      <div class="filter-section" *ngIf="selectedSource === 'inventory'">
        <h3>Expired in</h3>

        <div class="expired-input-group">
          <input
            type="number"
            [(ngModel)]="filter.expiredIn"
            placeholder="Enter days"
            min="0" />
          <span>day(s)</span>
        </div>

        <!-- âœ… Apply æŒ‰é’® -->
        <button class="apply-btn" (click)="applyExpiredFilter()">Apply</button>
        <!-- ðŸ”¹ Reset æŒ‰é’® -->
        <button class="reset-btn" (click)="resetExpiredFilter()">Reset</button>
      </div>
    </div>
    <!-- âœ… Filter Drawer END -->

    <!-- âœ… ç©ºçŠ¶æ€æç¤ºï¼šå±…ä¸­æ˜¾ç¤º -->
    <div *ngIf="successMessage" class="empty-alert">
      {{ successMessage }}
    </div>


    <!-- ðŸ”¹ æ¸²æŸ“ Storage â†’ Category â†’ Item -->
    <div *ngFor="let loc of viewLocs" class="location-block">
      <h1 *ngIf="selectedLocation === 'All'" class="location-title">{{ loc.name }}</h1>

      <div *ngFor="let category of loc.categories" class="category" [ngClass]="category.colorClass">
        <h2>{{ category.icon }} {{ category.name }}</h2>

        <!-- æ¯ä¸ªé£Ÿå“é¡¹ç›® -->
        <div
          *ngFor="let item of category.items"
          class="item"
          (mouseenter)="hoverItem = item"
          (mouseleave)="hoverItem = null">

          <!-- é£Ÿç‰©åç§° -->
          <div class="item-name" (mouseenter)="hoverItemNotes = item._id" (mouseleave)="hoverItemNotes = null">
            {{ item.name }}

            <!-- Notes å¡ç‰‡ï¼ˆhover æ‰æ˜¾ç¤ºï¼‰ -->
            <div class="item-notes-card" *ngIf="hoverItemNotes === item._id && item.notes">
              ðŸ“Œ {{ item.notes }}
            </div>
          </div>

                    <!-- âœ… Donation List / Inventory ç»Ÿä¸€ç»“æž„ï¼ˆé¿å…ä½œç”¨åŸŸè·‘é£žï¼‰ -->
                    <ng-container *ngIf="selectedSource === 'donation'; else normalItem">
                      <div class="donation-row">
                        <!-- å§‹ç»ˆæ˜¾ç¤º qty -->
                        <div class="remaining-box donation-view">{{ item.qty }}</div>

                        <!-- âœ… æ˜¾ç¤º availability / location -->
                        <div class="donation-meta">
                          pickup in
                          <strong>{{ item.donationAvailability || 'N/A' }}</strong>
                          at
                          <strong>{{ item.donationLocation || 'N/A' }}</strong>
                        </div>

                        <div class="edit-slot">
                          <button class="edit-btn" (click)="openConfirm(item, 'edit')">Edit</button>
                        </div>
                      </div>
                    </ng-container>

                    <!-- âœ… Inventory æ¨¡å¼ -->
                    <ng-template #normalItem>
                      <!-- å‰©ä½™æ•°é‡ï¼ˆqty ä¸€å®šæ˜¾ç¤ºï¼‰ -->
                      <div class="remaining-box" [ngClass]="getExpiryClass(item)">
                        {{ item.qty }}
                      </div>

                      <!-- å‰©ä½™å¤©æ•° -->
                      <div class="days-inline" [ngClass]="getExpiryClass(item)">
                        {{ getRemainingDays(item.expiry) <= 0 ? 'Expired' : getRemainingDays(item.expiry) + ' days left' }}
                      </div>

                      <!-- æ•°é‡æŽ§åˆ¶å™¨ -->
                      <div class="quantity-control">
                        <button type="button" (click)="decreaseSelected(item)">-</button>
                        <span class="qty">{{ item.selectedQty }}</span>
                        <button type="button" (click)="increaseSelected(item)">+</button>
                      </div>

                      <!-- æ“ä½œæŒ‰é’® -->
                      <div class="hover-actions" [class.visible]="hoverItem === item">
                        <button class="used" (click)="openConfirm(item, 'used')">Used</button>
                        <button class="meal" (click)="openConfirm(item, 'meal')">Meal</button>
                        <button class="donate" (click)="openConfirm(item, 'donate')">Donate</button>
                      </div>
                    </ng-template>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- ç¡®è®¤å¼¹çª— -->
<div
  class="modal-overlay"
  *ngIf="showConfirm && confirmAction"
  (click)="closeConfirm()">

  <div
    class="modal"
    [ngClass]="{
      'modal-used': confirmAction === 'used',
      'modal-meal': confirmAction === 'meal',
      'modal-donate': confirmAction === 'donate',
      'modal-edit': confirmAction === 'edit'
    }"
    (click)="$event.stopPropagation()">

    <h2>
      <ng-container [ngSwitch]="confirmAction">
        <ng-container *ngSwitchCase="'edit'">
          Edit donation item of <strong>{{ confirmItem?.name }}</strong>?
        </ng-container>
        <ng-container *ngSwitchCase="'donate'">
          Do you want to donate <strong>{{ confirmItem?.name }}</strong>?
        </ng-container>
        <ng-container *ngSwitchDefault>
          Do you want to mark {{ confirmItem?.selectedQty }}
          {{ confirmItem?.name }}(s) as {{ confirmAction }}?
        </ng-container>
      </ng-container>
    </h2>

    <div class="modal-buttons">
      <button class="cancel-btn" (click)="closeConfirm()">Cancel</button>
      <button
        class="action-btn"
        [ngClass]="{
          'btn-used': confirmAction === 'used',
          'btn-meal': confirmAction === 'meal',
          'btn-donate': confirmAction === 'donate',
          'btn-edit': confirmAction === 'edit'
        }"
        (click)="confirmActionProceed()">
        {{ confirmAction === 'edit' ? 'Edit' : (confirmAction | titlecase) }}
      </button>
    </div>
  </div>
</div>
